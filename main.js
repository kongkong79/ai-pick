const translations = {
    en: {
        appTitle: "Sports Betting Analysis",
        headerTitle: "Sports Betting Analysis",
        headerSubtitle: "Harness the power of AI for smarter sports betting. We provide free, data-driven predictions to help you make informed decisions.",
        analysisTitle: "Today's Betting Analysis",
        filterDescription: "Showing matches with ROI > 1, Sample Size > 10, and AI Hit Rate > 51%.",
        premiumTitle: "Premium Subscription",
        premiumSubtitle: "Get higher win rate predictions. Access exclusive data from our team of expert analysts.",
        subscribeButton: "Subscribe Now",
        footerText: "&copy; 2024 Sports Betting Analysis. All rights reserved.",
        cardTime: "Time",
        cardHomeOdds: "Home Odds",
        cardPrediction: "AI Prediction",
        cardProbability: "Hit Rate",
        cardRoi: "Expected ROI",
        noResults: "No matches found matching the criteria.",
        premiumLockTitle: "Premium Prediction",
        premiumLockMessage: "Subscribe to view predictions with over 80% hit rate.",
        toggleTheme: "Toggle Theme",
        navHome: "Home",
        navAbout: "About Us",
        navContact: "Contact",
        navPrivacy: "Privacy Policy"
    },
    ko: {
        appTitle: "ìŠ¤í¬ì¸  ë² íŒ… ë¶„ì„",
        headerTitle: "ìŠ¤í¬ì¸  ë² íŒ… ë¶„ì„",
        headerSubtitle: "AIì˜ íž˜ìœ¼ë¡œ ë” ìŠ¤ë§ˆíŠ¸í•œ ìŠ¤í¬ì¸  ë² íŒ…ì„ ê²½í—˜í•˜ì„¸ìš”. ì •ë³´ì— ê¸°ë°˜í•œ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìžˆë„ë¡ ë°ì´í„° ê¸°ë°˜ ì˜ˆì¸¡ì„ ë¬´ë£Œë¡œ ì œê³µí•©ë‹ˆë‹¤.",
        analysisTitle: "ì˜¤ëŠ˜ì˜ ë² íŒ… ë¶„ì„",
        filterDescription: "ROI > 1, í‘œë³¸ìˆ˜ > 10, AI ì ì¤‘ í™•ë¥  > 51%ì¸ ê²½ê¸°ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.",
        premiumTitle: "í”„ë¦¬ë¯¸ì—„ êµ¬ë…",
        premiumSubtitle: "ë” ë†’ì€ ìŠ¹ë¥ ì˜ ì˜ˆì¸¡ ì •ë³´ë¥¼ ë°›ì•„ë³´ì„¸ìš”. ì „ë¬¸ ë¶„ì„ê°€ íŒ€ì´ ì œê³µí•˜ëŠ” ë…ì  ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.",
        subscribeButton: "êµ¬ë…í•˜ê¸°",
        footerText: "&copy; 2024 ìŠ¤í¬ì¸  ë² íŒ… ë¶„ì„. ëª¨ë“  ê¶Œë¦¬ ë³´ìœ .",
        cardTime: "ê²½ê¸° ì‹œê°„",
        cardHomeOdds: "í™ˆíŒ€ ë°°ë‹¹ë¥ ",
        cardPrediction: "AI ì¶”ì²œ",
        cardProbability: "ì ì¤‘ í™•ë¥ ",
        cardRoi: "ì˜ˆìƒ ROI",
        noResults: "ì¡°ê±´ì— ë§žëŠ” ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.",
        premiumLockTitle: "í”„ë¦¬ë¯¸ì—„ ì˜ˆì¸¡",
        premiumLockMessage: "ì ì¤‘ë¥  80% ì´ìƒì˜ ì˜ˆì¸¡ì„ ë³´ë ¤ë©´ êµ¬ë…í•˜ì„¸ìš”.",
        toggleTheme: "í…Œë§ˆ ë³€ê²½",
        navHome: "í™ˆ",
        navAbout: "ì†Œê°œ",
        navContact: "ë¬¸ì˜í•˜ê¸°",
        navPrivacy: "ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨"
    },
    ja: {
        appTitle: "ã‚¹ãƒãƒ¼ãƒ„ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°åˆ†æž",
        headerTitle: "ã‚¹ãƒãƒ¼ãƒ„ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°åˆ†æž",
        headerSubtitle: "AIã®åŠ›ã§ã€ã‚ˆã‚Šã‚¹ãƒžãƒ¼ãƒˆãªã‚¹ãƒãƒ¼ãƒ„ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚’ã€‚æƒ…å ±ã«åŸºã¥ã„ãŸæ„æ€æ±ºå®šã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒ¼ã‚¿é§†å‹•åž‹ã®äºˆæ¸¬ã‚’ç„¡æ–™ã§æä¾›ã—ã¾ã™ã€‚",
        analysisTitle: "ä»Šæ—¥ã®ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°åˆ†æž",
        filterDescription: "ROI > 1, ã‚µãƒ³ãƒ—ãƒ«æ•° > 10, AIçš„ä¸­ç¢ºçŽ‡ > 51%ã®è©¦åˆã®ã¿è¡¨ç¤ºã—ã¾ã™ã€‚",
        premiumTitle: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è³¼èª­",
        premiumSubtitle: "ã‚ˆã‚Šé«˜ã„å‹çŽ‡ã®äºˆæ¸¬æƒ…å ±ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„ã€‚å°‚é–€ã‚¢ãƒŠãƒªã‚¹ãƒˆãƒãƒ¼ãƒ ã‹ã‚‰ã®ç‹¬å ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚",
        subscribeButton: "è³¼èª­ã™ã‚‹",
        footerText: "&copy; 2024 ã‚¹ãƒãƒ¼ãƒ„ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°åˆ†æž. å…¨è‘—ä½œæ¨©æ‰€æœ‰.",
        cardTime: "è©¦åˆæ™‚é–“",
        cardHomeOdds: "ãƒ›ãƒ¼ãƒ ãƒãƒ¼ãƒ ã®ã‚ªãƒƒã‚º",
        cardPrediction: "AIæŽ¨è–¦",
        cardProbability: "çš„ä¸­ç¢ºçŽ‡",
        cardRoi: "äºˆæƒ³ROI",
        noResults: "æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è©¦åˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
        premiumLockTitle: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ äºˆæ¸¬",
        premiumLockMessage: "çš„ä¸­çŽ‡80%ä»¥ä¸Šã®äºˆæ¸¬ã‚’è³¼èª­ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚",
        toggleTheme: "ãƒ†ãƒ¼ãƒžã‚’åˆ‡ã‚Šæ›¿ãˆ",
        navHome: "ãƒ›ãƒ¼ãƒ ",
        navAbout: "æ¦‚è¦",
        navContact: "ãŠå•ã„åˆã‚ã›",
        navPrivacy: "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼"
    },
    zh: {
        appTitle: "ä½“è‚²åšå½©åˆ†æž",
        headerTitle: "ä½“è‚²åšå½©åˆ†æž",
        headerSubtitle: "åˆ©ç”¨AIçš„åŠ›é‡è¿›è¡Œæ›´æ™ºèƒ½çš„ä½“è‚²åšå½©ã€‚æˆ‘ä»¬å…è´¹æä¾›æ•°æ®é©±åŠ¨çš„é¢„æµ‹ï¼Œä»¥å¸®åŠ©æ‚¨åšå‡ºæ˜Žæ™ºçš„å†³ç­–ã€‚",
        analysisTitle: "ä»Šæ—¥åšå½©åˆ†æž",
        filterDescription: "ä»…æ˜¾ç¤º ROI > 1ã€æ ·æœ¬é‡ > 10 ä¸” AI å‘½ä¸­çŽ‡ > 51% çš„æ¯”èµ›ã€‚",
        premiumTitle: "é«˜çº§è®¢é˜…",
        premiumSubtitle: "èŽ·å–æ›´é«˜èƒœçŽ‡çš„é¢„æµ‹ã€‚è®¿é—®æˆ‘ä»¬ä¸“å®¶åˆ†æžå¸ˆå›¢é˜Ÿçš„ç‹¬å®¶æ•°æ®ã€‚",
        subscribeButton: "ç«‹å³è®¢é˜…",
        footerText: "&copy; 2024 ä½“è‚²åšå½©åˆ†æž. ç‰ˆæƒæ‰€æœ‰.",
        cardTime: "æ¯”èµ›æ—¶é—´",
        cardHomeOdds: "ä¸»é˜Ÿèµ”çŽ‡",
        cardPrediction: "AIæŽ¨è",
        cardProbability: "å‘½ä¸­çŽ‡",
        cardRoi: "é¢„æœŸROI",
        noResults: "æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¯”èµ›ã€‚",
        premiumLockTitle: "é«˜çº§é¢„æµ‹",
        premiumLockMessage: "è®¢é˜…ä»¥æŸ¥çœ‹å‘½ä¸­çŽ‡è¶…è¿‡80%çš„é¢„æµ‹ã€‚",
        toggleTheme: "åˆ‡æ¢ä¸»é¢˜",
        navHome: "é¦–é¡µ",
        navAbout: "å…³äºŽæˆ‘ä»¬",
        navContact: "è”ç³»æˆ‘ä»¬",
        navPrivacy: "éšç§æ”¿ç­–"
    }
};

let currentLanguage = 'en';
let currentTheme = 'light';

function setLanguage(lang) {
    currentLanguage = lang;
    document.documentElement.lang = lang;
    document.querySelectorAll('[data-i18n-key]').forEach(elem => {
        const key = elem.getAttribute('data-i18n-key');
        if (translations[lang] && translations[lang][key]) {
            elem.innerHTML = translations[lang][key];
        }
    });
    loadAndDisplayExcelData();
}

function toggleTheme() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    localStorage.setItem('theme', currentTheme);
}

function applyInitialTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', currentTheme);
}

class BettingResultCard extends HTMLElement {
    constructor() {
        super();
        this.attachShadow({ mode: 'open' });
    }

    connectedCallback() {
        const isLocked = this.hasAttribute('locked');
        const t = translations[currentLanguage] || translations.en;

        const time = this.getAttribute('time');
        const homeTeam = this.getAttribute('home-team');
        const awayTeam = this.getAttribute('away-team');
        const prediction = this.getAttribute('prediction');
        const homeOdds = this.getAttribute('home-odds');
        const probability = this.getAttribute('probability');
        const roi = this.getAttribute('roi');

        let cardContent;

        if (isLocked) {
            cardContent = `
                <div class="card locked">
                    <div class="lock-overlay">
                        <span class="lock-icon">ðŸ”’</span>
                        <h3>${t.premiumLockTitle}</h3>
                        <p>${t.premiumLockMessage}</p>
                    </div>
                    <p><strong>${t.cardTime}:</strong> ${time}</p>
                    <h3>${homeTeam} vs ${awayTeam}</h3>
                     <div class="details blurred">
                        <p><strong>${t.cardPrediction}:</strong> ???</p>
                        <p><strong>${t.cardHomeOdds}:</strong> ${homeOdds}</p>
                        <p><strong>${t.cardProbability}:</strong> > 80%</p>
                        <p><strong>${t.cardRoi}:</strong> ???</p>
                    </div>
                </div>
            `;
        } else {
            cardContent = `
                <div class="card">
                    <p><strong>${t.cardTime}:</strong> ${time}</p>
                    <h3>${homeTeam} vs ${awayTeam}</h3>
                    <div class="details">
                        <p><strong>${t.cardPrediction}:</strong> ${prediction}</p>
                        <p><strong>${t.cardHomeOdds}:</strong> ${homeOdds}</p>
                        <p><strong>${t.cardProbability}:</strong> ${probability}</p>
                        <p><strong>${t.cardRoi}:</strong> ${roi}</p>
                    </div>
                </div>
            `;
        }

        this.shadowRoot.innerHTML = `
            <style>
                :host { display: block; }
                .card { position: relative; background-color: var(--primary-color, #ffffff); border-radius: 8px; padding: 1.5rem; border-left: 5px solid var(--accent-color, #007bff); box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease, border-color 0.3s ease; }
                .card:hover { transform: translateY(-5px); box-shadow: 0 8px 12px rgba(0,0,0,0.15); }
                h3, p { margin: 0; color: var(--text-color, #333); transition: color 0.3s ease;}
                h3 { font-size: 1.2rem; margin-bottom: 0.5rem; }
                p { font-size: 1rem; margin-bottom: 0.3rem; line-height: 1.4; }
                .details { margin-top: 0.75rem; border-top: 1px solid var(--border-color, #dee2e6); padding-top: 0.75rem; transition: border-color 0.3s ease; }
                .card.locked { border-left-color: var(--pending-color, #ffc107); }
                .lock-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 10; border-radius: 8px; }
                [data-theme="dark"] .lock-overlay { background: rgba(0, 0, 0, 0.7); }
                .lock-icon { font-size: 2.5rem; }
                .blurred { filter: blur(5px); user-select: none; }
            </style>
            ${cardContent}
        `;
    }
}

customElements.define('betting-result-card', BettingResultCard);

async function loadAndDisplayExcelData() {
    const container = document.getElementById('results-container');
    const filterDesc = document.getElementById('filter-description');
    container.innerHTML = '';
    const t = translations[currentLanguage] || translations.en;
    if(filterDesc) filterDesc.innerHTML = t.filterDescription;

    try {
        const response = await fetch('./today.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { cellDates: true });

        const filteredData = jsonData.filter(row => {
            const roi = parseFloat(row['Expected ROI']); 
            const sampleSize = parseInt(row['Sample Count'], 10);
            const hitRate = parseFloat(row['Hit rate']);
            return roi > 1 && sampleSize > 10 && hitRate > 51;
        });

        if (filteredData.length === 0) {
            container.innerHTML = `<p class="no-results">${t.noResults}</p>`;
            return;
        }

        filteredData.forEach(row => {
            const card = document.createElement('betting-result-card');
            const hitRate = parseFloat(row['Hit rate']);

            if (hitRate > 80) {
                card.setAttribute('locked', 'true');
            }

            let timeStr = 'N/A';
            const timeVal = row['Time'];

            if (timeVal instanceof Date) {
                timeStr = timeVal.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            } else if (typeof timeVal === 'number' && timeVal > 0 && timeVal < 1) {
                const totalMinutes = Math.floor(timeVal * 1440);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            } else if (timeVal) { 
                timeStr = String(timeVal);
            }

            card.setAttribute('time', timeStr);
            card.setAttribute('home-team', row['Home Team'] || 'N/A');
            card.setAttribute('away-team', row['Away Team'] || 'N/A');
            card.setAttribute('prediction', row['AI Recommendation'] || 'N/A');
            card.setAttribute('home-odds', row['Home Odds'] || 'N/A');
            card.setAttribute('probability', row['Hit rate'] || 'N/A');
            card.setAttribute('roi', row['Expected ROI'] || 'N/A');
            
            container.appendChild(card);
        });

    } catch (error) {
        console.error('Error loading or processing excel file:', error);
        container.innerHTML = `<p style="color: var(--loss-color);">Failed to load data. Please check the file and its headers.</p>`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    applyInitialTheme();

    const initialLang = navigator.language.split('-')[0];
    setLanguage(translations[initialLang] ? initialLang : 'en');

    document.getElementById('language-switcher').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const lang = e.target.getAttribute('data-lang');
            if (lang) setLanguage(lang);
        }
    });

    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

    document.getElementById('subscribe-button').addEventListener('click', () => {
        alert('Subscription feature is currently under development. Coming soon!');
    });
});
